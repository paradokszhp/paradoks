<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klub Planszówkowy</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --kolor-glowny-podstawowy: #a6ce39;
            --kolor-glowny-czlonek: #642888;
            --kolor-glowny-admin: #642888;
            --kolor-akcentu-admin: #FFD700;
            --kolor-tla: #f0f2f5;
            --kolor-karty: #ffffff;
            --kolor-tekstu: #1c1e21;
            --kolor-tekstu-drugorzedny: #606770;
            --kolor-przycisku-glownego: #642888;
            --kolor-przycisku-glownego-hover: #5a247a;
            --kolor-przycisku-drugorzednego: #6c757d;
            --kolor-przycisku-drugorzednego-hover: #5a6268;
            --kolor-przycisku-drugorzednego-tekst: #ffffff;
            --kolor-bledu: #dc3545;
            --cień-karty: 0 12px 28px 0 rgba(0, 0, 0, 0.08), 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--kolor-tla);
            color: var(--kolor-tekstu);
            transition: background-color 0.3s;
        }

        /* --- NOWY Ekran Logowania i Rejestracji --- */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            background-color: var(--kolor-tla);
        }

        .auth-wrapper {
            max-width: 500px;
            width: 100%;
            background-color: var(--kolor-karty);
            border-radius: 20px;
            box-shadow: var(--cień-karty);
            overflow: hidden;
        }

        .auth-form-container {
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .auth-form h1 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--kolor-tekstu);
            font-weight: 600;
            font-size: 2rem;
            text-align: center;
        }
        
        .auth-form p.subtitle {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--kolor-tekstu-drugorzedny);
        }

        .input-group {
            position: relative;
            margin-bottom: 1.25rem;
        }

        .input-group .icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
            width: 16px;
            height: 16px;
        }

        .auth-form input[type="text"],
        .auth-form input[type="tel"] {
            width: 100%;
            padding: 14px 14px 14px 45px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--kolor-przycisku-glownego);
            box-shadow: 0 0 0 2px rgba(100, 40, 136, 0.2);
        }

        .auth-form button {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            margin-bottom: 0.75rem;
        }
        
        .auth-form button:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--kolor-przycisku-glownego);
        }
        .btn-primary:hover {
            background-color: var(--kolor-przycisku-glownego-hover);
        }
        
        .btn-secondary {
            background-color: var(--kolor-przycisku-drugorzednego);
            color: var(--kolor-przycisku-drugorzednego-tekst);
        }
        
        .btn-secondary:hover {
            background-color: var(--kolor-przycisku-drugorzednego-hover);
        }

        #errorMessage,
        #regErrorMessage {
            color: var(--kolor-bledu);
            margin-top: 1rem;
            font-weight: 500;
            min-height: 20px;
            text-align: center;
        }
        
        .remember-me-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 1.25rem;
            font-size: 0.9rem;
            color: var(--kolor-tekstu-drugorzedny);
        }
        .remember-me-container input {
            margin-right: 8px;
            width: auto;
            padding: 0;
        }

        .terms-container {
            display: flex;
            align-items: flex-start;
            margin: 0.75rem 0;
            font-size: 0.8rem;
            text-align: left;
        }

        .terms-container:last-of-type {
            margin-bottom: 1.5rem;
        }
        .terms-container input {
            margin-top: 3px;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .terms-container label {
            color: var(--kolor-tekstu-drugorzedny);
        }
        .terms-container a {
            color: var(--kolor-przycisku-glownego);
            text-decoration: none;
            font-weight: 500;
        }
        .terms-container a:hover {
            text-decoration: underline;
        }
        
        .doc-button {
            display: block;
            padding: 10px 15px;
            margin-bottom: 10px;
            text-align: center;
            text-decoration: none;
            border-radius: 6px;
            background-color: var(--kolor-przycisku-drugorzednego);
            color: var(--kolor-przycisku-drugorzednego-tekst);
            transition: background-color 0.2s;
            border: none;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }

        .doc-button:hover {
            background-color: var(--kolor-przycisku-drugorzednego-hover);
        }

        /* --- Panel Aplikacji --- */
        .app-panel {
            display: none; /* Domyślnie ukryty */
            flex-direction: column;
            min-height: 100vh;
        }

        .app-header {
            padding: 15px 30px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .app-header .user-info {
            text-align: right;
        }

        .app-header .user-info span {
            display: block;
        }
        .app-header .user-info span:first-child {
            font-weight: bold;
            font-size: 1.1em;
        }

        .app-header button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .app-content {
            flex-grow: 1;
            padding: 25px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .grid-item {
            padding: 20px;
            border-radius: 8px;
        }

        .grid-item h3 {
            margin-top: 0;
            border-bottom: 2px solid;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th,
        td {
            padding: 12px;
            border: 1px solid;
            text-align: left;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        input,
        select,
        button {
            padding: 10px;
            font-size: 16px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            box-shadow: var(--cień-karty);
        }
        
         #infoModalButtons {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .meeting-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .meeting-item:last-child {
            border-bottom: none;
        }
         .meeting-item.past {
            text-decoration: line-through;
            opacity: 0.6;
        }


        /* Styl dla input[type=color] */
        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 44px;
            height: 28px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border-radius: 6px;
            border: 2px solid #ccc;
        }
        input[type="color"]::-moz-color-swatch {
            border-radius: 6px;
            border: 2px solid #ccc;
        }


        /* --- Motywy --- */

        /* Panel Podstawowy */
        body.podstawowy-jasny { background-color: #ffffff; color: #333; }
        body.podstawowy-jasny .grid-item { background-color: #f9f9f9; border: 1px solid #e0e0e0; }
        body.podstawowy-jasny .grid-item h3 { border-color: var(--kolor-glowny-podstawowy); color: var(--kolor-glowny-podstawowy); }
        body.podstawowy-jasny th, body.podstawowy-jasny td { border-color: #ddd; }
        body.podstawowy-jasny button { background-color: var(--kolor-glowny-podstawowy); color: white; border-color: var(--kolor-glowny-podstawowy); }
        body.podstawowy-jasny .modal-content { background-color: #fefefe; color: #333; }


        body.podstawowy-ciemny { background-color: #121212; color: #e0e0e0; }
        body.podstawowy-ciemny .grid-item { background-color: #1e1e1e; border: 1px solid #333; }
        body.podstawowy-ciemny .grid-item h3 { border-color: var(--kolor-glowny-podstawowy); color: var(--kolor-glowny-podstawowy); }
        body.podstawowy-ciemny th, body.podstawowy-ciemny td { border-color: #444; }
        body.podstawowy-ciemny button { background-color: var(--kolor-glowny-podstawowy); color: white; border-color: var(--kolor-glowny-podstawowy); }
        body.podstawowy-ciemny input, body.podstawowy-ciemny select { background-color: #333; color: #e0e0e0; border-color: #555; }
        body.podstawowy-ciemny .modal-content { background-color: #1e1e1e; color: #e0e0e0; border: 1px solid #333;}


        /* Panel Członka Klubu */
        body.czlonek-jasny { background-color: #ffffff; color: #333; }
        body.czlonek-jasny .grid-item { background-color: #f9f9f9; border: 1px solid #e0e0e0; }
        body.czlonek-jasny .grid-item h3 { border-color: var(--kolor-glowny-czlonek); color: var(--kolor-glowny-czlonek); }
        body.czlonek-jasny th, body.czlonek-jasny td { border-color: #ddd; }
        body.czlonek-jasny button { background-color: var(--kolor-glowny-czlonek); color: white; border-color: var(--kolor-glowny-czlonek); }
        body.czlonek-jasny .file-list a { background-color: #eee; color: #333; }
        body.czlonek-jasny .modal-content { background-color: #fefefe; color: #333; }


        body.czlonek-ciemny { background-color: #1e1e2f; color: #f0f0f0; }
        body.czlonek-ciemny .grid-item { background-color: #2c2c3e; border: 1px solid var(--kolor-glowny-czlonek); }
        body.czlonek-ciemny .grid-item h3 { border-color: var(--kolor-glowny-czlonek); color: #f0f0f0; }
        body.czlonek-ciemny th, body.czlonek-ciemny td { border-color: #444; }
        body.czlonek-ciemny button { background-color: var(--kolor-glowny-czlonek); color: white; border-color: var(--kolor-glowny-czlonek); }
        body.czlonek-ciemny input, body.czlonek-ciemny select { background-color: #3a3a50; color: #f0f0f0; border-color: var(--kolor-glowny-czlonek); }
        body.czlonek-ciemny .file-list a { background-color: #3a3a50; color: #f0f0f0; }
        body.czlonek-ciemny .modal-content { background-color: #2c2c3e; color: #f0f0f0; border: 1px solid var(--kolor-glowny-czlonek);}


        /* Panel Administratora */
        .admin-panel-layout { display: flex; flex-direction: row; height: 100%; }
        .admin-nav { display: flex; flex-direction: column; background-color: #2c2c3e; padding: 15px; min-width: 200px; }
        .admin-nav-link { background: none; border: none; color: white; text-align: left; padding: 15px; font-size: 1em; border-radius: 6px; margin-bottom: 5px; cursor: pointer; }
        .admin-nav-link.active { background-color: var(--kolor-glowny-admin); }
        .admin-content { flex-grow: 1; padding: 25px; overflow-y: auto; }
        .admin-tab-pane { display: none; }
        .admin-tab-pane.active { display: block; }
        
        body.admin-jasny { background-color: #f4f7fc; color: #333; }
        body.admin-jasny .admin-nav { background-color: #ffffff; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        body.admin-jasny .admin-nav-link { color: #333; }
        body.admin-jasny .admin-nav-link.active { color: white; }
        body.admin-jasny .admin-content { background-color: #f4f7fc; }
        body.admin-jasny .admin-content h3 { color: var(--kolor-glowny-admin); border-bottom: 2px solid var(--kolor-glowny-admin); padding-bottom: 10px; }
        body.admin-jasny table, body.admin-jasny th, body.admin-jasny td { border-color: #e0e0e0; }
        body.admin-jasny button { background-color: var(--kolor-glowny-admin); color: white; border: none; }
        body.admin-jasny button.edit-btn { background-color: var(--kolor-akcentu-admin); color: #333; }
        body.admin-jasny button.delete-btn { background-color: #dc3545; }
        body.admin-jasny input, body.admin-jasny select { background-color: #fff; color: #333; border: 1px solid #ccc; }
        body.admin-jasny input[type="color"]::-webkit-color-swatch { border-color: #ccc; }
        body.admin-jasny .modal-content { background-color: #fefefe; color: #333; }


        body.admin-ciemny { background-color: #1e1e2f; color: #f0f0f0; }
        body.admin-ciemny .admin-nav { background-color: #252535; }
        body.admin-ciemny .admin-content { background-color: #1e1e2f; }
        body.admin-ciemny .admin-content h3 { color: var(--kolor-akcentu-admin); border-bottom: 2px solid var(--kolor-glowny-admin); padding-bottom: 10px; }
        body.admin-ciemny table, body.admin-ciemny th, body.admin-ciemny td { border-color: #444; }
        body.admin-ciemny button { background-color: var(--kolor-glowny-admin); color: white; border: 1px solid var(--kolor-akcentu-admin); }
        body.admin-ciemny button.edit-btn { background-color: var(--kolor-akcentu-admin); color: #111; border: none; }
        body.admin-ciemny button.delete-btn { background-color: #dc3545; border: none; }
        body.admin-ciemny input, body.admin-ciemny select { background-color: #2c2c3e; color: #f0f0f0; border: 1px solid var(--kolor-glowny-admin); }
        body.admin-ciemny input[type="color"]::-webkit-color-swatch { border-color: var(--kolor-akcentu-admin); }
        body.admin-ciemny .modal-content { background-color: #252535; color: #f0f0f0; border: 1px solid var(--kolor-glowny-admin);}


        @media (max-width: 768px) {
            .admin-panel-layout { flex-direction: column; }
            .admin-nav { flex-direction: row; overflow-x: auto; min-width: auto; }
        }
    </style>
</head>

<body>

    <div id="authContainer" class="auth-container">
        <div class="auth-wrapper">
            <div class="auth-form-container">
                <!-- Ekran logowania -->
                <div id="loginScreen" class="auth-form">
                    <h1>Logowanie</h1>
                     <p class="subtitle">Wprowadź swoje dane, aby kontynuować.</p>
                    <div class="input-group">
                       <span class="icon">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5a5.5 5.5 0 0 1 5.5 5.5c0 1.571-.67 3.013-1.758 4.017C13.92 13.545 12 16.25 12 16.25s-1.92-2.705-3.742-4.233C7.17 11.013 6.5 9.57 6.5 8a5.5 5.5 0 0 1 5.5-5.5zM12 6a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/><path d="M12.562 21.313c.28.28.653.437 1.047.437H19.5a2.5 2.5 0 0 0 2.5-2.5v-6.91a.499.499 0 0 0-.494-.5c-.27 0-.503.22-.506.494v6.916a1.5 1.5 0 0 1-1.5 1.5h-5.89c-.19 0-.374-.075-.512-.213l-4.22-4.22a.5.5 0 0 0-.707 0l-4.22 4.22c-.138.138-.322.213-.512.213H2.5a1.5 1.5 0 0 1-1.5-1.5V12.34a.499.499 0 0 0-.506-.494.499.499 0 0 0-.494.5v6.91a2.5 2.5 0 0 0 2.5 2.5h5.89c.394 0 .767-.157 1.047-.437l4.125-4.125 4.125 4.125z"/></svg>
                       </span>
                        <input type="text" id="imie" placeholder="Imię">
                    </div>
                    <div class="input-group">
                       <span class="icon">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5a5.5 5.5 0 0 1 5.5 5.5c0 1.571-.67 3.013-1.758 4.017C13.92 13.545 12 16.25 12 16.25s-1.92-2.705-3.742-4.233C7.17 11.013 6.5 9.57 6.5 8a5.5 5.5 0 0 1 5.5-5.5zM12 6a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/><path d="M12.562 21.313c.28.28.653.437 1.047.437H19.5a2.5 2.5 0 0 0 2.5-2.5v-6.91a.499.499 0 0 0-.494-.5c-.27 0-.503.22-.506.494v6.916a1.5 1.5 0 0 1-1.5 1.5h-5.89c-.19 0-.374-.075-.512-.213l-4.22-4.22a.5.5 0 0 0-.707 0l-4.22 4.22c-.138.138-.322.213-.512.213H2.5a1.5 1.5 0 0 1-1.5-1.5V12.34a.499.499 0 0 0-.506-.494.499.499 0 0 0-.494.5v6.91a2.5 2.5 0 0 0 2.5 2.5h5.89c.394 0 .767-.157 1.047-.437l4.125-4.125 4.125 4.125z"/></svg>
                       </span>
                        <input type="text" id="nazwisko" placeholder="Nazwisko">
                    </div>
                    <div class="remember-me-container">
                        <input type="checkbox" id="rememberMe">
                        <label for="rememberMe">Zapamiętaj mnie</label>
                    </div>
                    <button id="loginButton" class="btn-primary">Zaloguj</button>
                    <button id="goToRegisterButton" class="btn-secondary">Utwórz nowe konto</button>
                    <p id="errorMessage"></p>
                </div>

                <!-- Ekran rejestracji -->
                <div id="registerScreen" class="auth-form" style="display: none;">
                    <h1>Rejestracja</h1>
                    <p class="subtitle">Dołącz do naszej społeczności graczy.</p>
                    <div class="input-group">
                         <span class="icon">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5a5.5 5.5 0 0 1 5.5 5.5c0 1.571-.67 3.013-1.758 4.017C13.92 13.545 12 16.25 12 16.25s-1.92-2.705-3.742-4.233C7.17 11.013 6.5 9.57 6.5 8a5.5 5.5 0 0 1 5.5-5.5zM12 6a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/><path d="M12.562 21.313c.28.28.653.437 1.047.437H19.5a2.5 2.5 0 0 0 2.5-2.5v-6.91a.499.499 0 0 0-.494-.5c-.27 0-.503.22-.506.494v6.916a1.5 1.5 0 0 1-1.5 1.5h-5.89c-.19 0-.374-.075-.512-.213l-4.22-4.22a.5.5 0 0 0-.707 0l-4.22 4.22c-.138.138-.322.213-.512.213H2.5a1.5 1.5 0 0 1-1.5-1.5V12.34a.499.499 0 0 0-.506-.494.499.499 0 0 0-.494.5v6.91a2.5 2.5 0 0 0 2.5 2.5h5.89c.394 0 .767-.157 1.047-.437l4.125-4.125 4.125 4.125z"/></svg>
                       </span>
                        <input type="text" id="regImie" placeholder="Imię" required>
                    </div>
                    <div class="input-group">
                        <span class="icon">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.5a5.5 5.5 0 0 1 5.5 5.5c0 1.571-.67 3.013-1.758 4.017C13.92 13.545 12 16.25 12 16.25s-1.92-2.705-3.742-4.233C7.17 11.013 6.5 9.57 6.5 8a5.5 5.5 0 0 1 5.5-5.5zM12 6a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/><path d="M12.562 21.313c.28.28.653.437 1.047.437H19.5a2.5 2.5 0 0 0 2.5-2.5v-6.91a.499.499 0 0 0-.494-.5c-.27 0-.503.22-.506.494v6.916a1.5 1.5 0 0 1-1.5 1.5h-5.89c-.19 0-.374-.075-.512-.213l-4.22-4.22a.5.5 0 0 0-.707 0l-4.22 4.22c-.138.138-.322.213-.512.213H2.5a1.5 1.5 0 0 1-1.5-1.5V12.34a.499.499 0 0 0-.506-.494.499.499 0 0 0-.494.5v6.91a2.5 2.5 0 0 0 2.5 2.5h5.89c.394 0 .767-.157 1.047-.437l4.125-4.125 4.125 4.125z"/></svg>
                       </span>
                        <input type="text" id="regNazwisko" placeholder="Nazwisko" required>
                    </div>
                    <div class="input-group">
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.05,20.5A3.5,3.5,0,0,1,2.55,17V7A3.5,3.5,0,0,1,6.05,3.5h11.9A3.5,3.5,0,0,1,21.45,7V17a3.5,3.5,0,0,1-3.5,3.5Zm.5-16A2.5,2.5,0,0,0,4.05,7V17a2.5,2.5,0,0,0,2.5,2.5h11.9a2.5,2.5,0,0,0,2.5-2.5V7a2.5,2.5,0,0,0-2.5-2.5Z"/><path d="M16.5,7.25a.75.75,0,0,0-1.5,0v.5a.75.75,0,0,0,1.5,0Z"/><path d="M15,15.5H9a.75.75,0,0,0,0,1.5h6a.75.75,0,0,0,0-1.5Z"/></svg>
                        </span>
                        <input type="tel" id="regTelefon" placeholder="Numer telefonu" required>
                    </div>
                    <div class="terms-container">
                        <input type="checkbox" id="regRegulaminKlubu" required>
                        <label for="regRegulaminKlubu">Akceptuję <a href="#" id="linkDoRegulaminuKlubu" target="_blank">regulamin klubu</a></label>
                    </div>
                    <div class="terms-container">
                        <input type="checkbox" id="regRegulaminWypozyczania" required>
                        <label for="regRegulaminWypozyczania">Akceptuję <a href="#" id="linkDoRegulaminuWypozyczania" target="_blank">regulamin wypożyczania gier</a></label>
                    </div>
                    <div class="terms-container">
                        <input type="checkbox" id="regKonstytucja" required>
                        <label for="regKonstytucja">Akceptuję <a href="#" id="linkDoKonstytucji" target="_blank">konstytucję klubu</a></label>
                    </div>
                    <button id="registerButton" class="btn-primary">Zarejestruj się</button>
                    <button id="backToLoginButton" class="btn-secondary">Masz już konto? Zaloguj się</button>
                    <p id="regErrorMessage"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="appPanel" class="app-panel">
        <!-- Treść aplikacji będzie renderowana tutaj -->
    </div>

    <!-- Modal do edycji formularzy -->
    <div id="formModal" class="modal">
        <div class="modal-content">
            <span id="closeFormModal" style="float:right; cursor:pointer;">&times;</span>
            <h2 id="formModalTitle">Edytuj</h2>
            <div id="formModalContent"></div>
        </div>
    </div>
    
    <!-- Modal do informacji, potwierdzeń i list -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span id="closeInfoModal" style="float:right; cursor:pointer;">&times;</span>
            <h2 id="infoModalTitle"></h2>
            <div id="infoModalBody"></div>
            <div id="infoModalButtons"></div>
        </div>
    </div>


    <script>
        // --- Konfiguracja Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyBB71iRGlgtxlhcbQpMIlbLtRF96kRxZ-g",
            authDomain: "klubplanszowkowy.firebaseapp.com",
            projectId: "klubplanszowkowy",
            storageBucket: "klubplanszowkowy.firebasestorage.app",
            messagingSenderId: "727125718017",
            appId: "1:727125718017:web:fdd4d6d1b30ae29b10bc00"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- Elementy DOM ---
        const authContainer = document.getElementById('authContainer');
        const loginScreen = document.getElementById('loginScreen');
        const registerScreen = document.getElementById('registerScreen');
        const appPanel = document.getElementById('appPanel');
        const errorMessage = document.getElementById('errorMessage');
        const regErrorMessage = document.getElementById('regErrorMessage');

        let currentUser = null;
        let appSettings = {};

        // --- Nawigacja ---
        document.getElementById('goToRegisterButton').addEventListener('click', async () => {
            if (!Object.keys(appSettings).length) {
                await fetchAppSettings();
            }
            document.getElementById('linkDoRegulaminuKlubu').href = appSettings.link_regulaminu_klubu || '#';
            document.getElementById('linkDoRegulaminuWypozyczania').href = appSettings.link_regulaminu_wypozyczania || '#';
            document.getElementById('linkDoKonstytucji').href = appSettings.link_konstytucji || '#';
            loginScreen.style.display = 'none';
            registerScreen.style.display = 'block';
        });

        document.getElementById('backToLoginButton').addEventListener('click', () => {
            registerScreen.style.display = 'none';
            loginScreen.style.display = 'block';
        });

        // --- Funkcje pomocnicze ---
        function showMessage(element, message, isError = true) {
            element.textContent = message;
            element.style.color = isError ? 'var(--kolor-bledu)' : '#28a745';
        }

        async function fetchAppSettings() {
            try {
                const settingsRef = db.collection('ustawienia').doc('global');
                const doc = await settingsRef.get();
                if (doc.exists) {
                    appSettings = doc.data();
                } else {
                    console.log("Brak dokumentu z ustawieniami, tworzę domyślny.");
                    const defaultSettings = {
                        kod_do_klodki: "11111",
                        link_regulaminu_klubu: "#",
                        link_regulaminu_wypozyczania: "#",
                        link_konstytucji: "#",
                        podstawowy_motyw: "jasny",
                        podstawowy_kolor_glowny: "#a6ce39",
                        czlonek_motyw: "ciemny",
                        czlonek_kolor_glowny: "#642888",
                        admin_motyw: "ciemny",
                        admin_kolor_glowny: "#642888",
                        admin_kolor_akcentu: "#FFD700",
                        limit_wypozyczen: 5,
                        limit_dni_wypozyczenia: 14
                    };
                    await settingsRef.set(defaultSettings);
                    appSettings = defaultSettings;
                }
                applyTheme();
            } catch (error) {
                console.error("Błąd podczas pobierania ustawień:", error);
            }
        }

        function applyTheme() {
            if (!currentUser) return;
            let themeClass = '';
            const root = document.documentElement;

            root.style.setProperty('--kolor-glowny-podstawowy', appSettings.podstawowy_kolor_glowny);
            root.style.setProperty('--kolor-glowny-czlonek', appSettings.czlonek_kolor_glowny);
            root.style.setProperty('--kolor-glowny-admin', appSettings.admin_kolor_glowny);
            root.style.setProperty('--kolor-akcentu-admin', appSettings.admin_kolor_akcentu);

            switch (currentUser.poziom_uprawnien) {
                case 'podstawowy':
                    themeClass = `podstawowy-${appSettings.podstawowy_motyw}`;
                    break;
                case 'członek klubu':
                    themeClass = `czlonek-${appSettings.czlonek_motyw}`;
                    break;
                case 'administrator':
                    themeClass = `admin-${appSettings.admin_motyw}`;
                    break;
            }
            document.body.className = themeClass;
        }

        async function renderApp() {
            if (!currentUser) return;

             // Check for expired ban on render
            if (currentUser.ban && currentUser.ban.active && currentUser.ban.expires) {
                 const expiryDate = new Date(currentUser.ban.expires.seconds * 1000);
                if (expiryDate <= new Date()) {
                    console.log("Ban expired. Unbanning user.");
                    await db.collection('uzytkownicy').doc(currentUser.id).update({ ban: { active: false } });
                    currentUser.ban.active = false; // Update local user object
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
            }


            applyTheme();

            switch (currentUser.poziom_uprawnien) {
                case 'podstawowy':
                    renderBasicPanel(currentUser);
                    break;
                case 'członek klubu':
                    renderMemberPanel(currentUser);
                    break;
                case 'administrator':
                    renderAdminPanel(currentUser);
                    break;
            }
            authContainer.style.display = 'none';
            appPanel.style.display = 'flex';
        }

        // --- Logowanie i Rejestracja ---
        document.getElementById('loginButton').addEventListener('click', async () => {
            const imie = document.getElementById('imie').value.trim();
            const nazwisko = document.getElementById('nazwisko').value.trim();
            if (!imie || !nazwisko) {
                return showMessage(errorMessage, "Wszystkie pola są wymagane.");
            }
            try {
                const snapshot = await db.collection('uzytkownicy')
                    .where('imie', '==', imie)
                    .where('nazwisko', '==', nazwisko)
                    .limit(1)
                    .get();

                if (snapshot.empty) {
                    return showMessage(errorMessage, "Nie znaleziono użytkownika.");
                }
                
                const rememberMeCheckbox = document.getElementById('rememberMe');
                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('loginImie', imie);
                    localStorage.setItem('loginNazwisko', nazwisko);
                } else {
                    localStorage.removeItem('loginImie');
                    localStorage.removeItem('loginNazwisko');
                }

                currentUser = {
                    id: snapshot.docs[0].id,
                    ...snapshot.docs[0].data()
                };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                await fetchAppSettings();
                renderApp();

            } catch (error) {
                console.error("Błąd logowania:", error);
                showMessage(errorMessage, "Wystąpił błąd podczas logowania.");
            }
        });

        document.getElementById('registerButton').addEventListener('click', async () => {
            const imie = document.getElementById('regImie').value.trim();
            const nazwisko = document.getElementById('regNazwisko').value.trim();
            const numer_telefonu = document.getElementById('regTelefon').value.trim();
            const regulaminKlubuChecked = document.getElementById('regRegulaminKlubu').checked;
            const regulaminWypozyczaniaChecked = document.getElementById('regRegulaminWypozyczania').checked;
            const konstytucjaChecked = document.getElementById('regKonstytucja').checked;

            if (!imie || !nazwisko || !numer_telefonu) {
                return showMessage(regErrorMessage, "Wszystkie pola są wymagane.");
            }
            if (!regulaminKlubuChecked || !regulaminWypozyczaniaChecked || !konstytucjaChecked) {
                return showMessage(regErrorMessage, "Musisz zaakceptować wszystkie dokumenty.");
            }

            try {
                const snapshot = await db.collection('uzytkownicy')
                    .where('imie', '==', imie)
                    .where('nazwisko', '==', nazwisko)
                    .get();

                if (!snapshot.empty) {
                    return showMessage(regErrorMessage, "Użytkownik o takim imieniu i nazwisku już istnieje.");
                }

                await db.collection('uzytkownicy').add({
                    imie,
                    nazwisko,
                    numer_telefonu,
                    poziom_uprawnien: 'podstawowy',
                    data_rejestracji: new Date()
                });
                showMessage(regErrorMessage, "Rejestracja pomyślna! Możesz się teraz zalogować.", false);
                setTimeout(() => {
                    registerScreen.style.display = 'none';
                    loginScreen.style.display = 'block';
                    document.getElementById('regRegulaminKlubu').checked = false;
                    document.getElementById('regRegulaminWypozyczania').checked = false;
                    document.getElementById('regKonstytucja').checked = false;
                }, 2000);

            } catch (error) {
                console.error("Błąd rejestracji:", error);
                showMessage(regErrorMessage, "Wystąpił błąd podczas rejestracji.");
            }
        });

        function logout() {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            appPanel.innerHTML = '';
            appPanel.style.display = 'none';
            authContainer.style.display = 'flex';
            loginScreen.style.display = 'block';
            registerScreen.style.display = 'none';
            document.body.className = '';
        }

        // --- Funkcje renderujące panele ---
        async function renderHeader(user) {
            return `
                <div class="app-header" style="background-color: ${getPrimaryColor(user.poziom_uprawnien)};">
                    <div class="user-info">
                        <span>${user.imie} ${user.nazwisko}</span>
                        <small>${user.poziom_uprawnien}</small>
                    </div>
                    <div class="user-info">
                        <span>Kod do kłódki: ${appSettings.kod_do_klodki}</span>
                    </div>
                    <button onclick="logout()">Wyloguj</button>
                </div>
            `;
        }

        function getPrimaryColor(poziom) {
            switch (poziom) {
                case 'podstawowy':
                    return appSettings.podstawowy_kolor_glowny;
                case 'członek klubu':
                    return appSettings.czlonek_kolor_glowny;
                case 'administrator':
                    return appSettings.admin_kolor_glowny;
                default:
                    return '#6c757d';
            }
        }

        async function renderBasicPanel(user) {
            const header = await renderHeader(user);
            const myRentalsTable = await getMyRentalsTable(user.id);
            const meetingsList = await getMeetingsList(user);
            const documentsHtml = getDocumentsHtml();
            const borrowGameHtml = getBorrowGameHtml(user);

            appPanel.innerHTML = `
                ${header}
                <div class="app-content">
                    <div class="grid-container">
                        ${borrowGameHtml}
                        <div class="grid-item">
                            <h3>Spotkania Klubu</h3>
                            ${meetingsList}
                        </div>
                        <div class="grid-item">
                            <h3>Moje Wypożyczone Gry</h3>
                            ${myRentalsTable}
                        </div>
                        ${documentsHtml}
                    </div>
                </div>
            `;
            const wypozyczForm = document.getElementById('wypozyczForm');
            if(wypozyczForm) {
                wypozyczForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    wypozyczGre(user);
                });
            }
        }

        async function renderMemberPanel(user) {
            const header = await renderHeader(user);
            const myRentalsTable = await getMyRentalsTable(user.id);
            const meetingsList = await getMeetingsList(user);
            const linksList = await getLinksList(false);
            const documentsHtml = getDocumentsHtml();
            const borrowGameHtml = getBorrowGameHtml(user);

            appPanel.innerHTML = `
                ${header}
                <div class="app-content">
                    <div class="grid-container">
                        ${borrowGameHtml}
                         <div class="grid-item">
                            <h3>Linki</h3>
                            <div class="file-list">${linksList}</div>
                        </div>
                        <div class="grid-item">
                            <h3>Spotkania Klubu</h3>
                            ${meetingsList}
                        </div>
                        <div class="grid-item">
                            <h3>Moje Wypożyczone Gry</h3>
                            ${myRentalsTable}
                        </div>
                        ${documentsHtml}
                    </div>
                </div>
            `;
             const wypozyczForm = document.getElementById('wypozyczForm');
            if(wypozyczForm) {
                wypozyczForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    wypozyczGre(user);
                });
            }
        }

        async function renderAdminPanel(user, activeTab = 'admin-borrow') {
            const header = await renderHeader(user);
            const tabs = [{
                id: 'admin-borrow',
                name: 'Wypożycz Grę'
            }, {
                id: 'admin-users',
                name: 'Użytkownicy'
            }, {
                id: 'admin-games',
                name: 'Gry'
            }, {
                id: 'admin-rentals',
                name: 'Wypożyczenia'
            }, {
                id: 'admin-links',
                name: 'Linki'
            }, {
                id: 'admin-meetings',
                name: 'Spotkania'
            }, {
                id: 'admin-settings',
                name: 'Ustawienia'
            }];

            appPanel.innerHTML = `
                ${header}
                <div class="app-content admin-panel-layout">
                    <nav class="admin-nav">
                        ${tabs.map(tab => `<button class="admin-nav-link ${tab.id === activeTab ? 'active' : ''}" data-tab="${tab.id}">${tab.name}</button>`).join('')}
                    </nav>
                    <main class="admin-content">
                        ${tabs.map(tab => `<div id="${tab.id}-content" class="admin-tab-pane ${tab.id === activeTab ? 'active' : ''}"></div>`).join('')}
                    </main>
                </div>
            `;

            await renderAdminTabContent(activeTab, user, true); // Force re-render

            appPanel.querySelector('.admin-nav').addEventListener('click', async (e) => {
                if (e.target.classList.contains('admin-nav-link')) {
                    const tabId = e.target.dataset.tab;
                    if (document.querySelector('.admin-nav-link.active')) {
                        document.querySelector('.admin-nav-link.active').classList.remove('active');
                    }
                    if (document.querySelector('.admin-tab-pane.active')) {
                        document.querySelector('.admin-tab-pane.active').classList.remove('active');
                    }
                    e.target.classList.add('active');
                    document.querySelector(`#${tabId}-content`).classList.add('active');
                    await renderAdminTabContent(tabId, user);
                }
            });
        }

        async function renderAdminTabContent(tabId, user, forceRender = false) {
            const contentEl = document.getElementById(`${tabId}-content`);
            if (!contentEl) return;
            if (contentEl.innerHTML.trim() !== '' && !forceRender) return;

            switch (tabId) {
                case 'admin-borrow':
                    const today = new Date().toISOString().split('T')[0];
                    contentEl.innerHTML = `
                        <h3>Wypożycz Grę</h3>
                        <form id="wypozyczForm">
                            <input type="number" id="numerGry" placeholder="Wpisz 4-cyfrowy numer gry" required>
                            <label for="dataZwrotu" style="margin-top: 10px; display: block;">Przewidywana data zwrotu:</label>
                            <input type="date" id="dataZwrotu" required min="${today}">
                            <button type="submit">Wypożycz</button>
                        </form>
                    `;
                    document.getElementById('wypozyczForm').addEventListener('submit', (e) => {
                        e.preventDefault();
                        wypozyczGre(user);
                    });
                    break;
                case 'admin-users':
                    contentEl.innerHTML = `<h3>Użytkownicy</h3><div id="usersTableContainer"></div>`;
                    await refreshUsersTable();
                    break;
                case 'admin-games':
                    contentEl.innerHTML = `<h3>Gry</h3><div id="gamesTableContainer"></div>`;
                    await refreshGamesTable();
                    break;
                case 'admin-rentals':
                    contentEl.innerHTML = `<h3>Historia Wypożyczeń</h3><div id="rentalsTableContainer"></div>`;
                    await refreshRentalsTable(true);
                    break;
                case 'admin-links':
                    contentEl.innerHTML = `<h3>Linki</h3><div id="linksTableContainer"></div>`;
                    await refreshLinksTable();
                    break;
                case 'admin-meetings':
                    contentEl.innerHTML = `<h3>Spotkania</h3><div id="meetingsTableContainer"></div>`;
                    await refreshMeetingsTable();
                    break;
                case 'admin-settings':
                    contentEl.innerHTML = `<h3>Ustawienia Aplikacji</h3><div id="settingsContainer"></div>`;
                    await refreshSettingsForm();
                    break;
            }
        }

        // --- Logika biznesowa (wypożyczenia, zwroty etc.) ---

        async function wypozyczGre(user) {
            if (user.ban && user.ban.active) {
                showCustomAlert("Zablokowane", "Twoje konto jest zablokowane. Nie możesz wypożyczać gier.", true);
                return;
            }
             // Administratorzy są wyłączeni z limitu
            if (user.poziom_uprawnien !== 'administrator') {
                const borrowLimit = appSettings.limit_wypozyczen;
                // Limit 0 oznacza brak limitu
                if (borrowLimit && borrowLimit > 0) {
                    const activeRentalsSnapshot = await db.collection('wypozyczenia')
                        .where('uzytkownik_id', '==', user.id)
                        .where('status', '==', 'aktywne')
                        .get();

                    if (activeRentalsSnapshot.size >= borrowLimit) {
                        showCustomAlert("Limit osiągnięty", `Osiągnięto limit wypożyczonych gier (${borrowLimit}). Zwróć grę, aby wypożyczyć nową.`, true);
                        return;
                    }
                }
            }

            const numerGry = parseInt(document.getElementById('numerGry').value, 10);
            const dataZwrotuValue = document.getElementById('dataZwrotu').value;

            if (!numerGry) {
                showCustomAlert("Brak danych", "Podaj numer gry.", true);
                return;
            }
            if (!dataZwrotuValue) {
                showCustomAlert("Brak danych", "Proszę wybrać przewidywaną datę zwrotu.", true);
                return;
            }

            const przewidywanaDataZwrotu = new Date(dataZwrotuValue);
            const dzis = new Date();
            dzis.setHours(0, 0, 0, 0); 

            if(przewidywanaDataZwrotu < dzis) {
                showCustomAlert("Nieprawidłowa data", "Data zwrotu nie może być z przeszłości.", true);
                return;
            }

            try {
                const gamesRef = db.collection('gry');
                const gameSnapshot = await gamesRef.where('numer_gry', '==', numerGry).limit(1).get();
                if (gameSnapshot.empty) {
                    showCustomAlert("Błąd", "Gra o podanym numerze nie istnieje.", true);
                    return;
                }
                const gameDoc = gameSnapshot.docs[0];
                if (!gameDoc.data().dostepnosc) {
                    showCustomAlert("Gra niedostępna", "Ta gra jest aktualnie wypożyczona.", true);
                    return;
                }

                await db.collection('wypozyczenia').add({
                    uzytkownik_id: user.id,
                    imie_nazwisko: `${user.imie} ${user.nazwisko}`,
                    gra_id: gameDoc.id,
                    numer_gry: numerGry,
                    nazwa_gry: gameDoc.data().nazwa_gry,
                    data_wypozyczenia: new Date(),
                    przewidywana_data_zwrotu: przewidywanaDataZwrotu,
                    status: 'aktywne'
                });

                await gamesRef.doc(gameDoc.id).update({
                    dostepnosc: false
                });
                showCustomAlert("Sukces!", "Gra została pomyślnie wypożyczona!");
                renderApp(); // Refresh view
            } catch (error) {
                console.error("Błąd przy wypożyczaniu gry:", error);
                showCustomAlert("Błąd", "Wystąpił błąd podczas wypożyczania.", true);
            }
        }

        async function zwrocGre(wypozyczenieId, graId) {
             showCustomConfirm('Potwierdzenie', 'Czy na pewno chcesz zwrócić tę grę?', async () => {
                try {
                    await db.collection('wypozyczenia').doc(wypozyczenieId).update({
                        status: 'zakończone',
                        data_zwrotu: new Date()
                    });
                    await db.collection('gry').doc(graId).update({ dostepnosc: true });
                    showCustomAlert("Sukces", "Gra została zwrócona.");
                    renderApp();
                } catch (error) {
                    console.error("Błąd przy zwrocie gry:", error);
                    showCustomAlert("Błąd", "Wystąpił błąd.", true);
                }
            });
        }
        
         async function markAttendance(meetingId, userId) {
            try {
                const meetingRef = db.collection('spotkania').doc(meetingId);
                await meetingRef.update({
                    attendees: firebase.firestore.FieldValue.arrayUnion(userId)
                });
                await renderApp();
            } catch (error) {
                console.error("Błąd podczas zapisywania obecności:", error);
                showCustomAlert("Błąd", "Wystąpił błąd.", true);
            }
        }


        // --- Funkcje pobierające dane ---
        async function getMyRentalsTable(userId) {
            const snapshot = await db.collection('wypozyczenia')
                .where('uzytkownik_id', '==', userId)
                .where('status', '==', 'aktywne')
                .get();

            if (snapshot.empty) return "<p>Nie masz aktualnie wypożyczonych gier.</p>";

            let table = `<table><thead><tr><th>Nr Gry</th><th>Nazwa</th><th>Data Wypożyczenia</th><th>Przewidywany Zwrot</th><th>Akcje</th></tr></thead><tbody>`;
            snapshot.forEach(doc => {
                const rental = doc.data();
                const rentalDate = rental.data_wypozyczenia.toDate();
                const limitDays = appSettings.limit_dni_wypozyczenia || 0;
                let isOverdue = false;

                if (limitDays > 0) {
                    const dueDate = new Date(rentalDate);
                    dueDate.setDate(dueDate.getDate() + limitDays);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); 
                    if (today > dueDate) {
                        isOverdue = true;
                    }
                }
                const przewidywanyZwrot = rental.przewidywana_data_zwrotu ? rental.przewidywana_data_zwrotu.toDate().toLocaleDateString() : '-';

                table += `
                    <tr style="${isOverdue ? 'background-color: #ffdddd;' : ''}">
                        <td>${rental.numer_gry}</td>
                        <td>${rental.nazwa_gry}</td>
                        <td>${rentalDate.toLocaleDateString()}</td>
                        <td>${przewidywanyZwrot}</td>
                        <td><button onclick="zwrocGre('${doc.id}', '${rental.gra_id}')">Zwróć</button></td>
                    </tr>
                `;
            });
            table += '</tbody></table>';
            return table;
        }

        async function getMeetingsList(user) {
            const snapshot = await db.collection('spotkania').orderBy('data_spotkania', 'desc').get();
            if (snapshot.empty) return "<p>Brak zaplanowanych spotkań.</p>";

            let list = '<div>';
            const now = new Date();
            snapshot.forEach(doc => {
                const spotkanie = doc.data();
                const dataSpotkania = spotkanie.data_spotkania.toDate();
                
                const endOfAttendance = new Date(dataSpotkania);
                endOfAttendance.setDate(endOfAttendance.getDate() + 1);
                endOfAttendance.setHours(23, 59, 59, 999);

                const isPast = now > endOfAttendance;
                const isFuture = now < dataSpotkania;
                const isActive = !isPast && !isFuture;
                
                const hasAttended = spotkanie.attendees && spotkanie.attendees.includes(user.id);
                
                let actionButton = '';
                if(isActive && !user.ban?.active) {
                    if(hasAttended) {
                        actionButton = `<button disabled>Obecny</button>`;
                    } else {
                        actionButton = `<button onclick="markAttendance('${doc.id}', '${user.id}')">Zaznacz obecność</button>`;
                    }
                }

                list += `
                    <div class="meeting-item ${isPast ? 'past' : ''}">
                        <span>${dataSpotkania.toLocaleString('pl-PL')}</span>
                        ${actionButton}
                    </div>
                `;
            });
            list += '</div>';
            return list;
        }

        async function getLinksList() {
            const snapshot = await db.collection('pliki').get();
            if (snapshot.empty) return "<p>Brak linków.</p>";
            return snapshot.docs.map(doc => {
                const plik = doc.data();
                return `<a href="${plik.link}" target="_blank" style="display:block; margin-bottom: 8px; padding: 10px; text-decoration: none; border-radius: 5px;">${plik.nazwa}</a>`;
            }).join('');
        }
        
        function getDocumentsHtml() {
            return `
                <div class="grid-item">
                    <h3>Dokumenty Klubu</h3>
                    <a href="${appSettings.link_regulaminu_klubu || '#'}" target="_blank" class="doc-button">Regulamin Klubu</a>
                    <a href="${appSettings.link_regulaminu_wypozyczania || '#'}" target="_blank" class="doc-button">Regulamin Wypożyczania</a>
                    <a href="${appSettings.link_konstytucji || '#'}" target="_blank" class="doc-button">Konstytucja Klubu</a>
                </div>
            `;
        }
        
        function getBorrowGameHtml(user) {
            if (user.ban && user.ban.active) {
                let message = '';
                if (user.ban.permanent) {
                    message = `<p style="color: var(--kolor-bledu); font-weight: 500;">Twoje konto jest zablokowane na stałe.</p>`;
                } else if (user.ban.expires) {
                    const expiryDate = new Date(user.ban.expires.seconds * 1000);
                    const remainingDays = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
                    message = `
                        <p style="color: var(--kolor-bledu); font-weight: 500;">Twoje konto jest zablokowane. Nie możesz wypożyczać gier.</p>
                        <p>Koniec blokady za: <strong>${remainingDays > 0 ? remainingDays : 0} dni</strong></p>`;
                }
                return `<div class="grid-item"><h3>Wypożycz Grę</h3>${message}</div>`;
            }

            const today = new Date().toISOString().split('T')[0];
            return `
                <div class="grid-item" id="borrow-game-section">
                    <h3>Wypożycz Grę</h3>
                    <form id="wypozyczForm">
                        <input type="number" id="numerGry" placeholder="Wpisz 4-cyfrowy numer gry" required>
                        <label for="dataZwrotu" style="margin-top: 10px; display: block;">Przewidywana data zwrotu:</label>
                        <input type="date" id="dataZwrotu" required min="${today}">
                        <button type="submit">Wypożycz</button>
                    </form>
                </div>`;
        }

        // --- Funkcje i odświeżanie dla panelu ADMINA ---

        function getActiveAdminTab() {
            const activeLink = document.querySelector('.admin-nav-link.active');
            return activeLink ? activeLink.dataset.tab : 'admin-borrow';
        }

        async function refreshUsersTable() {
            const container = document.getElementById('usersTableContainer');
            if (!container) return;
            let content = `
                <form id="admin-add-user-form">
                    <input type="text" id="admin-new-user-imie" placeholder="Imię" required>
                    <input type="text" id="admin-new-user-nazwisko" placeholder="Nazwisko" required>
                    <input type="tel" id="admin-new-user-telefon" placeholder="Numer Telefonu" required>
                    <button type="submit">Dodaj Użytkownika</button>
                </form>
            `;
            const snapshot = await db.collection('uzytkownicy').get();
            content += '<table><thead><tr><th>Imię</th><th>Nazwisko</th><th>Telefon</th><th>Poziom</th><th>Status</th><th>Akcje</th></tr></thead><tbody>';
            snapshot.forEach(doc => {
                const user = doc.data();
                let status = '<span style="color: green;">Aktywny</span>';
                let banActions = `<button onclick="banUser('${doc.id}', '6m')">Ban 6m</button> <button class="delete-btn" onclick="banUser('${doc.id}', 'permanent')">Ban na zawsze</button>`;

                if (user.ban && user.ban.active) {
                    if (user.ban.permanent) {
                        status = '<span style="color: red;">Zbanowany (na stałe)</span>';
                    } else if (user.ban.expires) {
                         const expiryDate = new Date(user.ban.expires.seconds * 1000);
                        if (expiryDate > new Date()) {
                            status = `<span style="color: orange;">Zbanowany (do ${expiryDate.toLocaleDateString()})</span>`;
                        }
                    }
                    banActions = `<button class="edit-btn" onclick="unbanUser('${doc.id}')">Odbanuj</button>`;
                }


                content += `
                    <tr>
                        <td>${user.imie}</td>
                        <td>${user.nazwisko}</td>
                        <td>${user.numer_telefonu || '-'}</td>
                        <td>${user.poziom_uprawnien}</td>
                        <td>${status}</td>
                        <td>
                            <button class="edit-btn" onclick="openEditModal('user', '${doc.id}')">Edytuj</button>
                            <button class="delete-btn" onclick="usunUzytkownika('${doc.id}')">Usuń</button>
                            ${banActions}
                             <button onclick="showUserAttendanceHistory('${doc.id}', '${user.imie} ${user.nazwisko}')">Historia</button>
                        </td>
                    </tr>
                `;
            });
            content += '</tbody></table>';
            container.innerHTML = content;
            document.getElementById('admin-add-user-form').addEventListener('submit', dodajUzytkownika);
        }

        async function dodajUzytkownika(e) {
            e.preventDefault();
            const imie = document.getElementById('admin-new-user-imie').value;
            const nazwisko = document.getElementById('admin-new-user-nazwisko').value;
            const numer_telefonu = document.getElementById('admin-new-user-telefon').value;
            if (!imie || !nazwisko || !numer_telefonu) {
                 showCustomAlert("Błąd", "Wypełnij wszystkie pola", true);
                return;
            }
            try {
                await db.collection('uzytkownicy').add({
                    imie,
                    nazwisko,
                    numer_telefonu,
                    poziom_uprawnien: 'podstawowy',
                    data_rejestracji: new Date()
                });
                await renderAdminTabContent(getActiveAdminTab(), currentUser, true);
            } catch (err) {
                console.error(err);
                showCustomAlert("Błąd", "Wystąpił błąd podczas dodawania użytkownika.", true);
            }
        }

        async function usunUzytkownika(id) {
            showCustomConfirm('Potwierdzenie', 'Na pewno usunąć użytkownika?', async () => {
                 try {
                    await db.collection('uzytkownicy').doc(id).delete();
                    await renderAdminTabContent(getActiveAdminTab(), currentUser, true);
                } catch(err) { console.error(err); showCustomAlert("Błąd", "Wystąpił błąd.", true); }
            });
        }
        
        async function banUser(id, duration) {
            showCustomConfirm('Potwierdzenie', 'Czy na pewno chcesz nałożyć bana na tego użytkownika?', async () => {
                let banData = { active: true };
                if (duration === 'permanent') {
                    banData.permanent = true;
                } else if (duration === '6m') {
                    const expiryDate = new Date();
                    expiryDate.setMonth(expiryDate.getMonth() + 6);
                    banData.expires = expiryDate;
                }

                try {
                    await db.collection('uzytkownicy').doc(id).update({ ban: banData });
                    await refreshUsersTable();
                } catch (err) {
                    console.error("Błąd podczas banowania użytkownika:", err);
                    showCustomAlert("Błąd", "Wystąpił błąd.", true);
                }
            });
        }

        async function unbanUser(id) {
            showCustomConfirm('Potwierdzenie', 'Czy na pewno chcesz zdjąć bana z tego użytkownika?', async () => {
                try {
                    await db.collection('uzytkownicy').doc(id).update({
                        ban: { active: false }
                    });
                    await refreshUsersTable();
                } catch (err) {
                    console.error("Błąd podczas odbanowywania użytkownika:", err);
                    showCustomAlert("Błąd", "Wystąpił błąd.", true);
                }
            });
        }

        async function refreshGamesTable() {
            const container = document.getElementById('gamesTableContainer');
            if (!container) return;
            let content = `
                 <form id="admin-add-game-form">
                     <input type="text" id="admin-new-game-name" placeholder="Nazwa gry" required>
                     <button type="submit">Dodaj Grę</button>
                 </form>
            `;
            const snapshot = await db.collection('gry').orderBy('numer_gry').get();
            content += '<table><thead><tr><th>Nr</th><th>Nazwa</th><th>Dostępność</th><th>Akcje</th></tr></thead><tbody>';
            snapshot.forEach(doc => {
                const game = doc.data();
                content += `
                    <tr>
                        <td>${game.numer_gry}</td>
                        <td>${game.nazwa_gry}</td>
                        <td>${game.dostepnosc ? 'Tak' : 'Nie'}</td>
                        <td>
                            <button class="edit-btn" onclick="openEditModal('game', '${doc.id}')">Edytuj</button>
                            <button class="delete-btn" onclick="usunGre('${doc.id}')">Usuń</button>
                        </td>
                    </tr>
                `;
            });
            content += '</tbody></table>';
            container.innerHTML = content;
            document.getElementById('admin-add-game-form').addEventListener('submit', dodajGre);
        }

        async function dodajGre(e) {
            e.preventDefault();
            const nazwa_gry = document.getElementById('admin-new-game-name').value;
            if (!nazwa_gry) {
                 showCustomAlert("Błąd", "Podaj nazwę gry", true);
                return;
            }
            try {
                const lastGameSnapshot = await db.collection('gry').orderBy('numer_gry', 'desc').limit(1).get();
                const nextNumber = lastGameSnapshot.empty ? 1 : lastGameSnapshot.docs[0].data().numer_gry + 1;
                await db.collection('gry').add({
                    nazwa_gry,
                    numer_gry: nextNumber,
                    dostepnosc: true
                });
                await renderAdminTabContent(getActiveAdminTab(), currentUser, true);
            } catch (err) {
                console.error(err);
                showCustomAlert("Błąd", "Wystąpił błąd.", true);
            }
        }

        async function usunGre(id) {
             showCustomConfirm('Potwierdzenie', 'Na pewno usunąć grę?', async () => {
                try {
                    await db.collection('gry').doc(id).delete();
                    await renderAdminTabContent(getActiveAdminTab(), currentUser, true);
                } catch(err) { console.error(err); showCustomAlert("Błąd", "Wystąpił błąd.", true); }
            });
        }

        async function refreshRentalsTable() {
            const container = document.getElementById('rentalsTableContainer');
            if (!container) return;
            const snapshot = await db.collection('wypozyczenia').orderBy('data_wypozyczenia', 'desc').get();
            let content = '<table><thead><tr><th>Nr Gry</th><th>Nazwa Gry</th><th>Wypożyczający</th><th>Data Wypożyczenia</th><th>Przewidywany Zwrot</th><th>Data Zwrotu</th><th>Akcje</th></tr></thead><tbody>';
            snapshot.forEach(doc => {
                const rental = doc.data();
                let rowStyle = '';

                if (rental.status === 'zakończone') {
                    rowStyle = 'opacity: 0.5';
                } else {
                    const limitDays = appSettings.limit_dni_wypozyczenia || 0;
                    if (limitDays > 0) {
                        const rentalDate = rental.data_wypozyczenia.toDate();
                        const dueDate = new Date(rentalDate);
                        dueDate.setDate(dueDate.getDate() + limitDays);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        if (today > dueDate) {
                            rowStyle = 'background-color: #ffdddd;';
                        }
                    }
                }
                
                const przewidywanyZwrot = rental.przewidywana_data_zwrotu ? rental.przewidywana_data_zwrotu.toDate().toLocaleDateString() : '-';
                content += `
                    <tr style="${rowStyle}">
                        <td>${rental.numer_gry}</td>
                        <td>${rental.nazwa_gry}</td>
                        <td>${rental.imie_nazwisko}</td>
                        <td>${rental.data_wypozyczenia.toDate().toLocaleDateString()}</td>
                        <td>${przewidywanyZwrot}</td>
                        <td>${rental.data_zwrotu ? rental.data_zwrotu.toDate().toLocaleDateString() : '-'}</td>
                        <td>${rental.status === 'aktywne' ? `<button onclick="zwrocGre('${doc.id}', '${rental.gra_id}')">Oznacz jako zwrócone</button>` : 'Zwrócono'}</td>
                    </tr>
                `;
            });
            content += '</tbody></table>';
            container.innerHTML = content;
        }

        async function refreshLinksTable() {
            const container = document.getElementById('linksTableContainer');
            if (!container) return;
            let content = `
                <form id="admin-add-link-form">
                    <input type="text" id="admin-new-link-name" placeholder="Nazwa wyświetlana" required>
                    <input type="url" id="admin-new-link-url" placeholder="Pełny URL" required>
                    <button type="submit">Dodaj Link</button>
                </form>
            `;
            const snapshot = await db.collection('pliki').get();
            content += '<table><thead><tr><th>Nazwa</th><th>Link</th><th>Akcje</th></tr></thead><tbody>';
            snapshot.forEach(doc => {
                const plik = doc.data();
                content += `
                    <tr>
                        <td>${plik.nazwa}</td>
                        <td><a href="${plik.link}" target="_blank">${plik.link}</a></td>
                        <td>
                            <button class="edit-btn" onclick="openEditModal('link', '${doc.id}')">Edytuj</button>
                            <button class="delete-btn" onclick="usunLink('${doc.id}')">Usuń</button>
                        </td>
                    </tr>
                `;
            });
            content += '</tbody></table>';
            container.innerHTML = content;
            document.getElementById('admin-add-link-form').addEventListener('submit', dodajLink);
        }

        async function dodajLink(e) {
            e.preventDefault();
            const nazwa = document.getElementById('admin-new-link-name').value;
            const link = document.getElementById('admin-new-link-url').value;
            if (!nazwa || !link) {
                 showCustomAlert("Błąd", "Wypełnij oba pola", true);
                return;
            }
            try {
                await db.collection('pliki').add({
                    nazwa,
                    link
                });
                await renderAdminTabContent(getActiveAdminTab(), currentUser, true);
            } catch (err) {
                console.error(err);
                showCustomAlert("Błąd", "Wystąpił błąd.", true);
            }
        }

        async function usunLink(id) {
            showCustomConfirm('Potwierdzenie', 'Na pewno usunąć link?', async () => {
                try {
                    await db.collection('pliki').doc(id).delete();
                    await renderAdminTabContent(getActiveAdminTab(), currentUser, true);
                } catch(err) { console.error(err); showCustomAlert("Błąd", "Wystąpił błąd.", true); }
            });
        }

        async function refreshMeetingsTable() {
            const container = document.getElementById('meetingsTableContainer');
            if (!container) return;
            let content = `
                <form id="admin-add-meeting-form">
                    <input type="datetime-local" id="admin-new-meeting-date" required>
                    <button type="submit">Dodaj Spotkanie</button>
                </form>
            `;
            const snapshot = await db.collection('spotkania').orderBy('data_spotkania', 'desc').get();
            content += '<table><thead><tr><th>Data Spotkania</th><th>Obecni</th><th>Akcje</th></tr></thead><tbody>';
            snapshot.forEach(doc => {
                const spotkanie = doc.data();
                const attendeeCount = spotkanie.attendees ? spotkanie.attendees.length : 0;
                content += `
                    <tr>
                        <td>${spotkanie.data_spotkania.toDate().toLocaleString('pl-PL')}</td>
                        <td>${attendeeCount}</td>
                        <td>
                             <button onclick="showMeetingAttendees('${doc.id}')">Pokaż obecnych</button>
                            <button class="edit-btn" onclick="openEditModal('meeting', '${doc.id}')">Edytuj</button>
                            <button class="delete-btn" onclick="usunSpotkanie('${doc.id}')">Usuń</button>
                        </td>
                    </tr>
                `;
            });
            content += '</tbody></table>';
            container.innerHTML = content;
            document.getElementById('admin-add-meeting-form').addEventListener('submit', dodajSpotkanie);
        }

        async function dodajSpotkanie(e) {
            e.preventDefault();
            const data_spotkania_str = document.getElementById('admin-new-meeting-date').value;
            if (!data_spotkania_str) {
                showCustomAlert("Błąd", "Wybierz datę i godzinę", true);
                return;
            }
            try {
                await db.collection('spotkania').add({
                    data_spotkania: new Date(data_spotkania_str),
                    attendees: []
                });
                await renderAdminTabContent(getActiveAdminTab(), currentUser, true);
            } catch (err) {
                console.error(err);
                showCustomAlert("Błąd", "Wystąpił błąd.", true);
            }
        }

        async function usunSpotkanie(id) {
             showCustomConfirm('Potwierdzenie', 'Na pewno usunąć spotkanie?', async () => {
                 try {
                    await db.collection('spotkania').doc(id).delete();
                    await renderAdminTabContent(getActiveAdminTab(), currentUser, true);
                } catch(err) { console.error(err); showCustomAlert("Błąd", "Wystąpił błąd.", true); }
            });
        }

        async function refreshSettingsForm() {
            const container = document.getElementById('settingsContainer');
            if (!container) return;
            container.innerHTML = `
                <form id="settings-form">
                    <h3>Ustawienia Globalne</h3>
                    <label for="kodDoKlodki">Kod do kłódki</label>
                    <input type="text" id="kodDoKlodki" value="${appSettings.kod_do_klodki || ''}">
                    <label for="limitWypozyczen">Limit wypożyczonych gier (0 = bez limitu)</label>
                    <input type="number" id="limitWypozyczen" value="${appSettings.limit_wypozyczen || 0}" min="0">
                    <label for="limitDniWypozyczenia">Limit dni na zwrot gry (0 = bez limitu)</label>
                    <input type="number" id="limitDniWypozyczenia" value="${appSettings.limit_dni_wypozyczenia || 14}" min="0">
                    <label for="linkRegulaminuKlubu">Link do regulaminu klubu</label>
                    <input type="url" id="linkRegulaminuKlubu" value="${appSettings.link_regulaminu_klubu || ''}">
                     <label for="linkRegulaminuWypozyczania">Link do regulaminu wypożyczania</label>
                    <input type="url" id="linkRegulaminuWypozyczania" value="${appSettings.link_regulaminu_wypozyczania || ''}">
                     <label for="linkKonstytucji">Link do konstytucji</label>
                    <input type="url" id="linkKonstytucji" value="${appSettings.link_konstytucji || ''}">

                    <h3>Panel Podstawowy</h3>
                    <label for="podstawowyKolor">Kolor główny</label>
                    <input type="color" id="podstawowyKolor" value="${appSettings.podstawowy_kolor_glowny}">
                    <label for="podstawowyMotyw">Motyw</label>
                    <select id="podstawowyMotyw">
                        <option value="jasny" ${appSettings.podstawowy_motyw === 'jasny' ? 'selected' : ''}>Jasny</option>
                        <option value="ciemny" ${appSettings.podstawowy_motyw === 'ciemny' ? 'selected' : ''}>Ciemny</option>
                    </select>

                    <h3>Panel Członka Klubu</h3>
                     <label for="czlonekKolor">Kolor główny</label>
                    <input type="color" id="czlonekKolor" value="${appSettings.czlonek_kolor_glowny}">
                    <label for="czlonekMotyw">Motyw</label>
                    <select id="czlonekMotyw">
                        <option value="jasny" ${appSettings.czlonek_motyw === 'jasny' ? 'selected' : ''}>Jasny</option>
                        <option value="ciemny" ${appSettings.czlonek_motyw === 'ciemny' ? 'selected' : ''}>Ciemny</option>
                    </select>

                    <h3>Panel Administratora</h3>
                     <label for="adminKolor">Kolor główny</label>
                    <input type="color" id="adminKolor" value="${appSettings.admin_kolor_glowny}">
                     <label for="adminAkcent">Kolor akcentu</label>
                    <input type="color" id="adminAkcent" value="${appSettings.admin_kolor_akcentu}">
                    <label for="adminMotyw">Motyw</label>
                    <select id="adminMotyw">
                        <option value="jasny" ${appSettings.admin_motyw === 'jasny' ? 'selected' : ''}>Jasny</option>
                        <option value="ciemny" ${appSettings.admin_motyw === 'ciemny' ? 'selected' : ''}>Ciemny</option>
                    </select>
                    
                    <button type="submit">Zapisz Ustawienia</button>
                </form>
            `;

            document.getElementById('settings-form').addEventListener('submit', zapiszUstawienia);
        }

        async function zapiszUstawienia(e) {
            e.preventDefault();
            const newSettings = {
                kod_do_klodki: document.getElementById('kodDoKlodki').value,
                link_regulaminu_klubu: document.getElementById('linkRegulaminuKlubu').value,
                link_regulaminu_wypozyczania: document.getElementById('linkRegulaminuWypozyczania').value,
                link_konstytucji: document.getElementById('linkKonstytucji').value,
                podstawowy_motyw: document.getElementById('podstawowyMotyw').value,
                podstawowy_kolor_glowny: document.getElementById('podstawowyKolor').value,
                czlonek_motyw: document.getElementById('czlonekMotyw').value,
                czlonek_kolor_glowny: document.getElementById('czlonekKolor').value,
                admin_motyw: document.getElementById('adminMotyw').value,
                admin_kolor_glowny: document.getElementById('adminKolor').value,
                admin_kolor_akcentu: document.getElementById('adminAkcent').value,
                limit_wypozyczen: parseInt(document.getElementById('limitWypozyczen').value, 10) || 0,
                limit_dni_wypozyczenia: parseInt(document.getElementById('limitDniWypozyczenia').value, 10) || 0
            };

            try {
                await db.collection('ustawienia').doc('global').set(newSettings);
                appSettings = newSettings; // Update local copy
                applyTheme(); // Re-apply theme immediately
                showCustomAlert("Sukces", "Ustawienia zapisane!");
                await renderAdminTabContent(getActiveAdminTab(), currentUser, true);
            } catch (err) {
                console.error("Błąd zapisu ustawień:", err);
                showCustomAlert("Błąd", "Błąd podczas zapisywania.", true);
            }
        }

        // --- Logika Modala ---
        const formModal = document.getElementById('formModal');
        const formModalContent = document.getElementById('formModalContent');
        const formModalTitle = document.getElementById('formModalTitle');

        const infoModal = document.getElementById('infoModal');
        const infoModalTitle = document.getElementById('infoModalTitle');
        const infoModalBody = document.getElementById('infoModalBody');
        const infoModalButtons = document.getElementById('infoModalButtons');

        document.getElementById('closeFormModal').onclick = () => { formModal.style.display = 'none'; };
        document.getElementById('closeInfoModal').onclick = () => { infoModal.style.display = 'none'; };
        
        window.onclick = (event) => {
            if (event.target == formModal) { formModal.style.display = 'none'; }
            if (event.target == infoModal) { infoModal.style.display = 'none'; }
        };

        function showCustomAlert(title, message, isError = false) {
            infoModalTitle.textContent = title;
            infoModalBody.innerHTML = `<p>${message}</p>`;
            infoModalBody.style.color = isError ? 'var(--kolor-bledu)' : 'inherit';
            infoModalButtons.innerHTML = `<button class="btn-primary">OK</button>`;
            infoModalButtons.querySelector('button').onclick = () => { infoModal.style.display = 'none'; };
            infoModal.style.display = 'flex';
        }

        function showCustomConfirm(title, message, onConfirm) {
            infoModalTitle.textContent = title;
            infoModalBody.innerHTML = `<p>${message}</p>`;
            infoModalBody.style.color = 'inherit';
            infoModalButtons.innerHTML = `
                <button id="confirm-cancel" class="btn-secondary">Anuluj</button>
                <button id="confirm-ok" class="btn-primary">OK</button>
            `;
            infoModal.style.display = 'flex';
            
            document.getElementById('confirm-ok').onclick = () => {
                infoModal.style.display = 'none';
                onConfirm();
            };
             document.getElementById('confirm-cancel').onclick = () => {
                infoModal.style.display = 'none';
            };
        }

        async function openEditModal(type, id) {
             formModalTitle.textContent = 'Edytuj'; // Reset title
            const doc = await db.collection(getCollectionName(type)).doc(id).get();
            const data = doc.data();
            let content = '';

            switch (type) {
                case 'user':
                    content = `
                        <form id="edit-form">
                            <label>Imię</label><input id="edit-imie" value="${data.imie}">
                            <label>Nazwisko</label><input id="edit-nazwisko" value="${data.nazwisko}">
                            <label>Telefon</label><input id="edit-telefon" value="${data.numer_telefonu}">
                            <label>Poziom</label>
                            <select id="edit-poziom">
                                <option ${data.poziom_uprawnien === 'podstawowy' ? 'selected' : ''}>podstawowy</option>
                                <option ${data.poziom_uprawnien === 'członek klubu' ? 'selected' : ''}>członek klubu</option>
                                <option ${data.poziom_uprawnien === 'administrator' ? 'selected' : ''}>administrator</option>
                            </select>
                            <button type="submit">Zapisz</button>
                        </form>
                    `;
                    break;
                case 'game':
                    content = `<form id="edit-form"><label>Nazwa gry</label><input id="edit-nazwa" value="${data.nazwa_gry}"><button type="submit">Zapisz</button></form>`;
                    break;
                case 'link':
                    content = `<form id="edit-form"><label>Nazwa</label><input id="edit-nazwa" value="${data.nazwa}"><label>Link</label><input id="edit-link" value="${data.link}"><button type="submit">Zapisz</button></form>`;
                    break;
                case 'meeting':
                    const dateString = data.data_spotkania.toDate().toISOString().slice(0, 16);
                    content = `<form id="edit-form"><label>Data</label><input type="datetime-local" id="edit-data" value="${dateString}"><button type="submit">Zapisz</button></form>`;
                    break;
            }
            formModalContent.innerHTML = content;
            formModal.style.display = 'flex';

            const editForm = document.getElementById('edit-form');
            if(editForm) {
                 editForm.addEventListener('submit', (e) => saveEdit(e, type, id));
            }
        }
        
         async function showMeetingAttendees(meetingId) {
            infoModalTitle.textContent = 'Lista Obecności';
            infoModalButtons.innerHTML = '';
            const meetingDoc = await db.collection('spotkania').doc(meetingId).get();
            if (!meetingDoc.exists) return;

            const meetingData = meetingDoc.data();
            const attendeeIds = meetingData.attendees || [];

            if (attendeeIds.length === 0) {
                infoModalBody.innerHTML = '<p>Nikt nie potwierdził obecności.</p>';
                infoModal.style.display = 'flex';
                return;
            }

            const attendeePromises = attendeeIds.map(id => db.collection('uzytkownicy').doc(id).get());
            const attendeeDocs = await Promise.all(attendeePromises);
            const attendeeNames = attendeeDocs
                .map(doc => doc.exists ? `<li>${doc.data().imie} ${doc.data().nazwisko}</li>` : '<li>Użytkownik usunięty</li>')
                .join('');
            
            infoModalBody.innerHTML = `<ul>${attendeeNames}</ul>`;
            infoModal.style.display = 'flex';
        }
        
         async function showUserAttendanceHistory(userId, userName) {
            infoModalTitle.textContent = `Historia obecności: ${userName}`;
            infoModalButtons.innerHTML = '';
            const snapshot = await db.collection('spotkania')
                .where('attendees', 'array-contains', userId)
                .get();

            if (snapshot.empty) {
                infoModalBody.innerHTML = '<p>Brak historii obecności.</p>';
                infoModal.style.display = 'flex';
                return;
            }

            const sortedMeetings = snapshot.docs.sort((a, b) => {
                const dateA = a.data().data_spotkania.toDate();
                const dateB = b.data().data_spotkania.toDate();
                return dateB - dateA;
            });

            const meetingDates = sortedMeetings
                .map(doc => `<li>${doc.data().data_spotkania.toDate().toLocaleString('pl-PL')}</li>`)
                .join('');
            
            infoModalBody.innerHTML = `<ul>${meetingDates}</ul>`;
            infoModal.style.display = 'flex';
        }


        function getCollectionName(type) {
            const map = {
                user: 'uzytkownicy',
                game: 'gry',
                link: 'pliki',
                meeting: 'spotkania'
            };
            return map[type];
        }

        async function saveEdit(e, type, id) {
            e.preventDefault();
            let dataToUpdate = {};
            switch (type) {
                case 'user':
                    dataToUpdate = {
                        imie: document.getElementById('edit-imie').value,
                        nazwisko: document.getElementById('edit-nazwisko').value,
                        numer_telefonu: document.getElementById('edit-telefon').value,
                        poziom_uprawnien: document.getElementById('edit-poziom').value
                    };
                    break;
                case 'game':
                    dataToUpdate = {
                        nazwa_gry: document.getElementById('edit-nazwa').value
                    };
                    break;
                case 'link':
                    dataToUpdate = {
                        nazwa: document.getElementById('edit-nazwa').value,
                        link: document.getElementById('edit-link').value
                    };
                    break;
                case 'meeting':
                    dataToUpdate = {
                        data_spotkania: new Date(document.getElementById('edit-data').value)
                    };
                    break;
            }
            try {
                await db.collection(getCollectionName(type)).doc(id).update(dataToUpdate);
                formModal.style.display = 'none';
                await renderAdminTabContent(getActiveAdminTab(), currentUser, true);
            } catch (err) {
                console.error("Błąd zapisu:", err);
                showCustomAlert("Błąd", "Wystąpił błąd.", true);
            }
        }

        // --- Inicjalizacja Aplikacji ---
        function loadRememberedUser() {
            const savedImie = localStorage.getItem('loginImie');
            const savedNazwisko = localStorage.getItem('loginNazwisko');

            if (savedImie && savedNazwisko) {
                document.getElementById('imie').value = savedImie;
                document.getElementById('nazwisko').value = savedNazwisko;
                document.getElementById('rememberMe').checked = true;
            }
        }
        
        async function initApp() {
            const storedUser = sessionStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                await fetchAppSettings();
                renderApp();
            }
        }
        initApp();
        loadRememberedUser();
    </script>
</body>
</html>

